<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>UB Weather & PM2.5 Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    canvas { max-width: 900px; margin: 40px auto; display: block; }
    h1, p { text-align: center; }
    #lastUpdated { font-weight: bold; margin-top: 10px; }
    #pmAlert { font-weight: bold; color: red; margin-bottom: 20px; }
  </style>
</head>
<body>
  <h1>UB Weather & Air Quality</h1>
  <p>Live data from weather.gov.mn and embassy PM2.5 monitors</p>
  <p><a href="weather_log.csv" download>Download CSV</a></p>
  <p id="lastUpdated">Last updated: loading‚Ä¶</p>
  <p id="pmAlert"></p>

  <canvas id="pmChart"></canvas>
  <canvas id="weatherChart"></canvas>
  <canvas id="windChart"></canvas>

  <script>
    async function loadCSV() {
      const res = await fetch("weather_log.csv");
      const text = await res.text();
      const rows = text.trim().split("\n");
      const header = rows[0].split("\t"); // tab-separated
      const dataRows = rows.slice(1);

      // map headers to index
      const colIndex = {};
      header.forEach((h, i) => { colIndex[h.trim()] = i; });

      const timestamps = [];
      const temps = [];
      const humidities = [];
      const windSpeeds = [];
      const french = [];
      const eu = [];
      const czech = [];
      const yarmag = [];

      for (const row of dataRows) {
        const cols = row.split("\t");

        timestamps.push(cols[colIndex["timestamp"]]);
        temps.push(parseFloat(cols[colIndex["temperature"]]) || null);
        windSpeeds.push(parseFloat(cols[colIndex["wind_speed"]]) || null);
        humidities.push(parseFloat(cols[colIndex["humidity"]]) || null);
        french.push(parseFloat(cols[colIndex["pm25_french"]]) || null);
        eu.push(parseFloat(cols[colIndex["pm25_eu"]]) || null);
        czech.push(parseFloat(cols[colIndex["pm25_czech"]]) || null);
        yarmag.push(parseFloat(cols[colIndex["pm25_yarmag"]]) || null);
      }

      const latest = timestamps[timestamps.length - 1];
      document.getElementById("lastUpdated").textContent =
        `Last updated: ${latest} (Ulaanbaatar time)`;

      // Threshold alert logic
      const latestVals = [
        french[french.length - 1],
        eu[eu.length - 1],
        czech[czech.length - 1],
        yarmag[yarmag.length - 1]
      ].filter(v => v !== null);

      let alertMsg = "";
      if (latestVals.some(v => v > 55)) {
        alertMsg = "üö® Unhealthy air quality. Limit outdoor activity.";
      } else if (latestVals.some(v => v > 35)) {
        alertMsg = "‚ö†Ô∏è Air quality may affect sensitive groups.";
      }
      document.getElementById("pmAlert").textContent = alertMsg;

      // Destroy old charts (if reloaded)
      if (window.pmChart) window.pmChart.destroy();
      if (window.weatherChart) window.weatherChart.destroy();
      if (window.windChart) window.windChart.destroy();

      // PM2.5 chart
      window.pmChart = new Chart(document.getElementById("pmChart"), {
        type: "line",
        data: {
          labels: timestamps,
          datasets: [
            { label: "French Embassy PM2.5", data: french, borderColor: "green", fill: false },
            { label: "EU Delegation PM2.5", data: eu, borderColor: "blue", fill: false },
            { label: "Czech Embassy PM2.5", data: czech, borderColor: "orange", fill: false },
            { label: "Yarmag Garden City PM2.5", data: yarmag, borderColor: "purple", fill: false }
          ]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { mode: "index", intersect: false }, legend: { position: "top" } },
          scales: {
            x: { title: { display: true, text: "Timestamp" } },
            y: { title: { display: true, text: "PM2.5 (¬µg/m¬≥)" } }
          }
        }
      });

      // Weather chart
      window.weatherChart = new Chart(document.getElementById("weatherChart"), {
        type: "line",
        data: {
          labels: timestamps,
          datasets: [
            { label: "Temperature (¬∞C)", data: temps, borderColor: "red", fill: false },
            { label: "Humidity (%)", data: humidities, borderColor: "blue", fill: false }
          ]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { mode: "index", intersect: false }, legend: { position: "top" } },
          scales: {
            x: { title: { display: true, text: "Timestamp" } },
            y: { title: { display: true, text: "Value" } }
          }
        }
      });

      // Wind chart
      window.windChart = new Chart(document.getElementById("windChart"), {
        type: "line",
        data: {
          labels: timestamps,
          datasets: [
            { label: "Wind Speed (m/s)", data: windSpeeds, borderColor: "teal", fill: false }
          ]
        },
        options: {
          responsive: true,
          plugins: { tooltip: { mode: "index", intersect: false }, legend: { position: "top" } },
          scales: {
            x: { title: { display: true, text: "Timestamp" } },
            y: { title: { display: true, text: "Wind Speed (m/s)" } }
          }
        }
      });
    }

    loadCSV();
    setInterval(loadCSV, 1800000); // refresh every 30 minutes
  </script>
</body>
</html>
